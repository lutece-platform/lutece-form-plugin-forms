<@cTpl>
<#include "/skin/plugins/asynchronousupload/upload_commons.html" />
<@addRequiredJsFiles />
<script src="jsp/site/plugins/asynchronousupload/GetMainUploadJs.jsp?handler=formsAsynchronousUploadHandler" ></script>
<script>
function getInputElement( displayControl ){
	const types = ['input','select','textarea'];
	let elm = null;
	const container = document.querySelector("div[displayControl='" + displayControl + "']");
	if (!container) return [];
	
	for(let i=0; i<types.length && (elm == null || elm.length === 0); i++){
		elm = container.querySelectorAll(types[i]);
	}
	
	if( elm && elm.length > 0 && elm[0].tagName.toLowerCase() === 'input' ){
		elm = document.querySelectorAll('input[name="' + elm[0].getAttribute('name') + '"]');
	}
	return elm ? Array.from(elm) : [];
}

function getFieldValue(elm) {
	if (!elm) return null;
	
	// Handle NodeList from querySelectorAll
	if (elm instanceof NodeList) {
		elm = Array.from(elm);
	}
	
	// Handle array of elements (radio/checkbox)
	if (Array.isArray(elm)) {
		const firstElm = elm[0];
		if (firstElm && firstElm.type === 'radio') {
			const checked = elm.find(el => el.checked);
			return checked ? checked.value : null;
		} else if (firstElm && firstElm.type === 'checkbox') {
			return elm.filter(el => el.checked).map(el => el.value);
		}
		return firstElm ? firstElm.value : null;
	}
	
	// Handle single element
	if (elm.tagName.toLowerCase() === 'select') {
		return elm.options[elm.selectedIndex].value;
	}
	
	return elm.value;
}
</script>
<form id="form-validate" action="jsp/site/Portal.jsp?page=forms" method="post" enctype="multipart/form-data">
	<#if form.logo??>
		<img id="form_logo" src="data:${form.logo.mimeType};base64,${form.logoBase64}" title="${form.title}" alt=""/>
	</#if>
	<@messages warnings=warnings />
	<#if messageInfo?? >
	<div class="alert alert-info" role="alert">
		${messageInfo}
	</div>
	</#if>
	${formTopBreadcrumb!}
	<#if form.countResponses>#i18n{forms.create_entry.manageField.labelFieldNumber}: ${form.currentNumberResponse}</#if>
	${stepContent!}
	${formBottomBreadcrumb!}
</form>
<div id="upload-info-message" class="alert alert-warning text-center d-none" role="alert">
	#i18n{forms.create_entry.warning.upload.inprogress}
</div>
<script>
let isUploading = false;
document.addEventListener('fileuploadstart', function () {
	isUploading = true;
});

document.addEventListener('fileuploadstop', function () {
	isUploading = false;
	document.getElementById('upload-info-message').classList.add('d-none');
});

document.getElementById('form-validate').addEventListener('submit', function(e) {
	if (isUploading) {
		e.preventDefault();
		document.getElementById('upload-info-message').classList.remove('d-none');
	}
});
</script>
</@cTpl>