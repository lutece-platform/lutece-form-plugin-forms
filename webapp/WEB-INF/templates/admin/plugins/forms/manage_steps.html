<#include "/admin/plugins/forms/edit_form_tabs.html" />
<#assign hasInitial=0>
<#assign hasFinal=0>
<#assign stepTitle=''>
<@pageContainer>
    <@pageColumn>
		<@pageHeader title='${form.title!}'>
			<@tform type='inline'>
				<@formGroup labelFor='plugin_type' labelKey='#i18n{portal.system.manage_plugins.buttonFilter}' hideLabel=['all'] formStyle='inline'>
					<@inputGroup>
						<@input type='text' name='search_step' id='search_step' placeHolder='#i18n{portal.system.manage_plugins.buttonFilter}' params='autocomplete="off" addons' />
						<@button color='primary' title='#i18n{portal.system.manage_plugins.buttonFilter}' buttonIcon='filter' hideTitle=['all'] />
					</@inputGroup>
				</@formGroup>
			</@tform>
			<#if form.active>
				<#if extendableResourceActionsHtml?? && extendableResourceActionsHtml?has_content>${extendableResourceActionsHtml!}</#if>
				<@button type='button' id='forms-action' class='mx-2' title='#i18n{forms.dashboard.row_actions}' buttonIcon='cog' dropdownMenu=true >
					<@aButton color='default dropdown-item justify-content-start' href='jsp/site/Portal.jsp?page=forms&view=stepView&id_form=${form.id}&init=true' title='#i18n{forms.manageForm.FOLink.label} ${form.title} [#i18n{portal.site.portal_footer.newWindow}]' params='target="_blank"' buttonIcon='external-link' />
					<@aButton color='default dropdown-item justify-content-start' href='jsp/admin/plugins/forms/ManageFormResponse.jsp?view=stepView&id_form=${form.id}&init=true' title='#i18n{forms.manageForm.BOLink.label} ${form.title}' buttonIcon='text-plus' />
					<@aButton color='default dropdown-item justify-content-start' href='jsp/admin/plugins/forms/MultiviewForms.jsp?current_selected_panel=forms&id_form=${form.id}' title='#i18n{forms.manageForm.MultiviewLink.label} [#i18n{portal.site.portal_footer.newWindow}]' params='target="_blank"' buttonIcon='list-alt' />
					<#if form.breadcrumbName=='forms-breadcrumbaccordion.breadcrumbAccordion'>
					<@aButton color='default dropdown-item justify-content-start' href='jsp/admin/plugins/forms/modules/breadcrumbaccordion/ManageBreadcrumbAccordion.jsp?view=modifyBreadcrumb&id_form=${form.id}' title='#i18n{module.forms.breadcrumbaccordion.manage_breadcrumbAccordion.title}' buttonIcon='stack' />
					</#if>
					<@button type='button' class='default dropdown-item justify-content-start' id='toggleMap' title='Voir le graphique' buttonIcon='sitemap' />
				</@button>
			</#if>
		</@pageHeader>
		<@formBreadCrumb><@breadcrumbItem>${form.title!} </@breadcrumbItem></@formBreadCrumb>	
		<@formTabs tab='steps'>
			<@tabContent>
				<@tabPanel id='tabpanel' active=true>
					<#if step_list?size gt 0>
					<@row class='justify-content-end mb-3 '>
						<@columns class='col-auto gap-2'>
							<@aButton href='jsp/admin/plugins/forms/ManageSteps.jsp?view=createStep&id_form=${form.id}'  buttonIcon='plus' title='#i18n{forms.manage_steps.buttonAdd}' params='data-bs-toggle="offcanvas" data-bs-target="#offcanvasCreateStep" data-url="jsp/admin/plugins/forms/ManageSteps.jsp?view=createStep&id_form=${form.id}"' />
						</@columns>
						<#if template_provider??>
							<@columns class='col-auto gap-2'>
								<@offcanvas id="import-template" title="#i18n{forms.manage_steps.buttonImportTemplate}" position="end" btnTitle="#i18n{forms.manage_steps.buttonImportTemplate}" btnIcon="new-section" hideTitle=['xs','sm'] size="sm" >
								<@tform method='post' name='upload_form' action='jsp/admin/plugins/forms/ManageSteps.jsp'>
									<@input type='hidden' name='token' value='${token}' />
									<@input type='hidden' name='id_form' value='${form.id}' />
									<@row>
									<#if template_provider.stepTemplateList?has_content>
										<#list template_provider.stepTemplateList?sort_by("name") as item>
										<@columns xs='6'>
											<label class="form-imagecheck mb-2">
												<input name="id_template" type="radio" value="${item.code}" class="form-imagecheck-input"  />
												<span class="form-imagecheck-figure">
												<svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="form-imagecheck-image icon icon-tabler icons-tabler-outline icon-tabler-list-details"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M13 5h8" /><path d="M13 9h5" /><path d="M13 15h8" /><path d="M13 19h5" /><path d="M3 4m0 1a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v4a1 1 0 0 1 -1 1h-4a1 1 0 0 1 -1 -1z" /><path d="M3 14m0 1a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v4a1 1 0 0 1 -1 1h-4a1 1 0 0 1 -1 -1z" /></svg>
												<span class="d-inline-block w-100 text-center fw-bold text-wrap">${item.name!}</span>
											</label>
										</@columns>
										</#list>
									</#if>
									</@row>
									<@formGroup rows=2>
										<@button type='submit' name='action_doImportTemplate' buttonIcon='check' title='#i18n{portal.admin.message.buttonValidate}' />
										<@button type='cancel' name='action_doCancelImport' buttonIcon='times' title='#i18n{portal.admin.message.buttonCancel}' cancel=true />
									</@formGroup>
								</@tform>
								</@offcanvas>
							</@columns>
						</#if>
						<@columns class='col-auto gap-2'>
							<@offcanvas id="import-json" title="#i18n{forms.manageForm.buttonImport}" position="end" btnTitle="#i18n{forms.manage_steps.buttonImport}" btnIcon="upload" hideTitle=['xs','sm']>
								<@tform id='importJsonModal' method='post' name='upload_form' action='jsp/admin/plugins/forms/ManageSteps.jsp' params='enctype="multipart/form-data"'>
									<@input type="hidden" name="token" value = "${token}" />
									<@input type='hidden' name='id_form' value='${form.id}' />
									<@formGroup labelKey='#i18n{forms.manageForm.labelImportFile}' helpKey='#i18n{forms.manageForm.labelImportFile.help}' rows=2>
										<@input type='file' name='json_file'/>
									</@formGroup>
									<@formGroup rows=2>
										<@button type='submit' name='action_doImportJson' buttonIcon='check' title='#i18n{portal.admin.message.buttonValidate}' />
										<@button type='cancel' name='action_doCancelImport' buttonIcon='times' title='#i18n{portal.admin.message.buttonCancel}' cancel=true />
									</@formGroup>
								</@tform>
							</@offcanvas>
						</@columns>
					</@row>
					<@row id='step-list' class='row-cols-1 row-cols-sm-2 row-cols-xl-3'>
						<#list step_list as step>
						<#assign stepTitle=step.title!?replace('- hidden','') />
						<@columns>
							<@box id='step_${step.id}'>
								<#assign stepTitle>
								<@link class='searchable' href='jsp/admin/plugins/forms/ManageQuestions.jsp?view=manageQuestions&id_step=${step.id}' title=''><@icon style='list me-2' /> ${stepTitle}</@link>
								<#if step.initial><@tag color='success' class='me-2'>#i18n{forms.manage_steps.columnInitial}</@tag> <#assign hasInitial=1 > </#if>
								<#if step.final><@tag color='warning' class='me-2'>#i18n{forms.manage_steps.columnFinal}</@tag> <#assign hasFinal=1 ></#if>
								</#assign>
								<@boxHeader title=stepTitle  />
								<@boxBody class='d-flex justify-content-between'>
									<@div class='d-flex d-none d-lg-block'><#if step.description !=''>${step.description!}<#else>#i18n{manage_steps.noDescriptionLabel}</#if></@div>
									<@div class='d-flex justify-content-between align-items-center'>
										<#if transition_list??>
											<#assign stepTransition = transition_list?filter( transition -> transition.fromStep = step.id ) />
											<#if stepTransition?? && stepTransition?size gt 0>
											<@row class='me-2'>
												<@columns>
												<@h level=3 class='me-5 d-none d-lg-block'>#i18n{forms.manage_transitions.title}</@h>
												<@listGroup>
													<#list transition_list as transition>
														<#if transition.fromStep = step.id>
														<@listGroupItem class='py-1 d-none d-lg-block'>
															<#assign stepTitle=step.title!?replace('- hidden','') />
															<@link href='jsp/admin/plugins/forms/ManageTransitions.jsp?view=manageTransitions&id_step=${transition.fromStep}' title='#i18n{forms.modify_transition.title} ${stepTitle!}'>
																<@tag title='#i18n{forms.manage_transitions.columnPriority}'>${(transition.priority)!}</@tag> ${(transition.nextStepTitle?replace('- hidden',''))!''}  
																${(transition.controlTitle)!''}<#if transition.conditional> (#i18n{forms.manage_questions.columnCondition}) </#if>
															</@link>
														</@listGroupItem>
														</#if>	
													</#list>
												</@listGroup>
												</@columns>
											</@row>
											</#if>	 
										</#if>	 
										<@div class='d-flex align-items-center'>
											<@link href='jsp/admin/plugins/forms/ManageTransitions.jsp?view=manageTransitions&id_step=${step.id}' label='' class='btn btn-primary me-1'><@icon style='cog' /><@span class='visually-hidden'> #i18n{forms.manage_steps.action.modifyStep}</@span></@link>
											<@button type='button' id='forms-action' title='Actions' dropdownMenu=true >
												<@link href='jsp/admin/plugins/forms/ManageSteps.jsp?action=duplicateStep&id_step=${step.id}&token=${token}' label='' class='dropdown-item'> <@icon style='copy' /> #i18n{forms.manage_steps.action.copyStep}</@link>
												<@link href='jsp/admin/plugins/forms/ManageSteps.jsp?action=doExportJson&id_step=${step.id}' label='' class='dropdown-item'> <@icon style='download' /> #i18n{forms.manage_steps.action.exportStep}</@link>
												<@link href='jsp/admin/plugins/forms/ManageQuestions.jsp?view=manageQuestions&id_step=${step.id}' label='' class='dropdown-item'> <@icon style='list' /> #i18n{forms.manage_steps.action.showquestions}</@link>
												<@link href='jsp/admin/plugins/forms/ManageSteps.jsp?view=confirmRemoveStep&id_step=${step.id}' label='' class='dropdown-item'> <@icon style='trash text-danger' /> #i18n{forms.manage_steps.action.removeStep}</@link> 
											</@button>
										</@div>
									</@div>
								</@boxBody>
							</@box>
						</@columns>
						</#list>
					</@row>
					<#if hasFinal=0 && hasInitial=0 >
						<#assign msg="#i18n{forms.manage_steps.warning.no.initial.final}" />
					<#elseif hasFinal=1  && hasInitial=0>	
						<#assign msg="#i18n{forms.manage_steps.warning.no.initial}" />
					<#elseif hasFinal=0  && hasInitial=1>	
						<#assign msg="#i18n{forms.manage_steps.warning.no.final}" />
					<#else>
						<#assign msg="" />				
					</#if>
					<#if msg?? && msg != '' &&  step_list?size gt 0><@alert color='warning' title=msg! iconTitle='alert-triangle' dismissible=true /></#if>
					<@paginationAdmin paginator=paginator combo=1 showcount=0 />
				<#else>
					<@empty subtitle='#i18n{forms.multiviewForms.view_record_history.history_empty}' title='#i18n{forms.manage_steps.warning.no.initial.final}' />
					<@div class='d-flex justify-content-center'>
						<!-- <@offcanvas targetUrl="jsp/admin/plugins/forms/ManageSteps.jsp?view=createStep&id_form=${form.id}" targetElement="#create-step" id="step-${form.id}"  btnIcon="plus" btnTitle="#i18n{forms.manage_steps.buttonAdd}" btnColor="primary" position="end" title="#i18n{forms.manage_steps.buttonAdd}" size="half"/> -->
						 <@aButton href='jsp/admin/plugins/forms/ManageSteps.jsp?view=createStep&id_form=${form.id}' class='me-2' buttonIcon='plus' title='#i18n{forms.manage_steps.buttonAdd}' params='data-bs-toggle="offcanvas" data-bs-target="#offcanvasCreateStep" data-url="jsp/admin/plugins/forms/ManageSteps.jsp?view=createStep&id_form=${form.id}"' />
						<#if template_provider??>
							<@offcanvas id="import-template" title="#i18n{forms.manage_steps.buttonImportTemplate}" position="end" btnTitle="#i18n{forms.manage_steps.buttonImportTemplate}" btnIcon="new-section" size="sm" >
							<@tform  method='post' name='upload_form' action='jsp/admin/plugins/forms/ManageSteps.jsp'>
								<@input type='hidden' name='token' value='${token}' />
								<@input type='hidden' name='id_form' value='${form.id}' />
								<@row>
								<#if template_provider.stepTemplateList?has_content>
									<#list template_provider.stepTemplateList?sort_by("name") as item>
									<div class="col-6">
										<label class="form-imagecheck mb-2">
											<input name="id_template" type="radio" value="${item.code}" class="form-imagecheck-input" />
											<span class="form-imagecheck-figure">
											<svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="form-imagecheck-image icon icon-tabler icons-tabler-outline icon-tabler-list-details"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M13 5h8" /><path d="M13 9h5" /><path d="M13 15h8" /><path d="M13 19h5" /><path d="M3 4m0 1a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v4a1 1 0 0 1 -1 1h-4a1 1 0 0 1 -1 -1z" /><path d="M3 14m0 1a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v4a1 1 0 0 1 -1 1h-4a1 1 0 0 1 -1 -1z" /></svg>
											<span class="d-inline-block w-100 text-center fw-bold text-wrap">${item.name!}</span>
										</label>
									</div>
									</#list>
								</#if>
								</@row>
								<@formGroup rows=2>
									<@button type='submit' name='action_doImportTemplate' class='me-2' buttonIcon='check' title='#i18n{portal.admin.message.buttonValidate}' />
									<@button type='cancel' name='action_doCancelImport' buttonIcon='times' title='#i18n{portal.admin.message.buttonCancel}' cancel=true />
								</@formGroup>
							</@tform>
							</@offcanvas>
						</#if>
						<@offcanvas id="import-json" title="#i18n{forms.manageForm.buttonImport}" position="end" btnTitle="#i18n{forms.manage_steps.buttonImport}" btnIcon="upload" >
							<@tform id='importJsonModal' method='post' name='upload_form' action='jsp/admin/plugins/forms/ManageSteps.jsp' params='enctype="multipart/form-data"'>
								<@input type="hidden" name="token" value = "${token}" />
								<@input type='hidden' name='id_form' value='${form.id}' />
								<@formGroup labelKey='#i18n{forms.manageForm.labelImportFile}' helpKey='#i18n{forms.manageForm.labelImportFile.help}' rows=2>
									<@input type='file' name='json_file'/>
								</@formGroup>
								<@formGroup rows=2>
									<@button type='submit' name='action_doImportJson' buttonIcon='check' title='#i18n{portal.admin.message.buttonValidate}' />
									<@button type='cancel' name='action_doCancelImport' buttonIcon='times' title='#i18n{portal.admin.message.buttonCancel}' cancel=true />
								</@formGroup>
							</@tform>
						</@offcanvas>
					</@div>
				</#if>	
				</@tabPanel>
			</@tabContent>
		</@formTabs>
	</@pageColumn>
</@pageContainer>	
<@offcanvasIframe id='offcanvasCreateStep' label='#i18n{forms.manage_steps.buttonAdd}' />
<@offcanvasIframe id='offcanvasTransition'  />
<script type="module">
import LuteceSearchList from './themes/shared/modules/luteceSearchList.js';
const searchInput = document.querySelector("#search_step");
const searchElementList = document.querySelectorAll("#step-list .col");
new LuteceSearchList( searchInput, searchElementList, {
	searchableChild: [".searchable",".card-title"],
	highlight: true,
	toggleList: true,
	toggleRow: true,
	toggleRowSelector: '#step-list',
	toggleLabel: '#i18n{portal.util.labelToggleList}',
	toggleLabelOff: '#i18n{portal.util.labelToggleListOff}',
	toggleCardClass: ['card-list','flex-row'], 
	toggleCardHeaderClass : ['flex-row','justify-content-start','align-items-center'],  
});

const stepsArray = [];
document.querySelectorAll('[id^="step_"]').forEach(step => {
	const idStep = step.id.replace('step_', '');
	const stepTitle = step.querySelector('.card-header .card-title').textContent.trim();
	stepsArray.push({ id: idStep, title: stepTitle });
});
sessionStorage.setItem('stepList${form.id}', JSON.stringify(stepsArray));
let startStepId = null;
let isLinking = false;

document.querySelectorAll('[id^="step_"]').forEach(card => {
	card.addEventListener('mousedown', function(e) {
		startStepId = this.id.replace('step_', '');
		isLinking = true;
		this.classList.add('linking-start');
		document.body.style.cursor = 'crosshair';
	});
	card.addEventListener('dblclick', function(e) {
		const cardTitleLink = this.querySelector('.card-header .card-title a');
		if (cardTitleLink) {
			window.location.href = cardTitleLink.href;
		}
	});
});

document.addEventListener('mouseover', function(e) {
	if (isLinking && e.target.closest('[id^="step_"]') != null && e.target.closest('[id^="step_"]').id.replace('step_', '') !== startStepId ) {
		document.querySelectorAll('[id^="step_"]').forEach(card => card.classList.remove('linking-target'));
		e.target.closest('[id^="step_"]').classList.add('linking-target');
	}
});

document.addEventListener('mouseup', function(e) {
	if ( isLinking && e.target.closest('[id^="step_"]') != null ) {
		const stepToken=encodeURIComponent('${token}')
		let endStepId = e.target.closest('[id^="step_"]').id.replace('step_', '');
		if (startStepId && endStepId && startStepId !== endStepId) {
			// AJAX call to define the link
			fetch('jsp/admin/plugins/forms/ManageTransitions.jsp', {
				method: 'POST',
				headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
				<#noparse>body: `action_createTransition=&id_step=${startStepId}&fromStep=${startStepId}&id_step=${endStepId}`</#noparse>
			}).then(() => location.reload());
		}
	}

	// Reset
	isLinking = false;
	startStepId = null;
	document.body.style.cursor = '';
	document.querySelectorAll('[id^="step_"]').forEach(card => {
		card.classList.remove('linking-start');
		card.classList.remove('linking-target');
	});
});
</script>
<@formModal />
<@modal id='importJsonModal'>
	<@modalHeader modalTitle='#i18n{forms.manage_steps.buttonImport}' />
	<@modalBody>
		<@tform class='form' method='post' name='upload_form' action='jsp/admin/plugins/forms/ManageSteps.jsp' params='enctype="multipart/form-data"'>
			<@input type='hidden' name='token' value='${token}' />
			<@input type='hidden' name='id_form' value='${form.id}' />
			<@formGroup labelKey='#i18n{forms.manageForm.labelImportFile}' helpKey='#i18n{forms.manageForm.labelImportFile.help}' rows=2>
				<@input type='file' name='json_file'/>
			</@formGroup>
			<@formGroup>
				<@button type='submit' name='action_doImportJson' buttonIcon='check' title='#i18n{portal.admin.message.buttonValidate}' />
				<@button type='cancel' name='action_doCancelImport' buttonIcon='times' title='#i18n{portal.admin.message.buttonCancel}' cancel=true />
			</@formGroup>
		</@tform>
	</@modalBody>
</@modal>
<#if template_provider??>
	<@modal id='importTemplateModal'>
		<@modalHeader modalTitle='#i18n{forms.manage_steps.buttonImportTemplate}' />
		<@modalBody>
			<@tform class='form' method='post' name='upload_form' action='jsp/admin/plugins/forms/ManageSteps.jsp'>
				<@input type='hidden' name='token' value='${token}' />
				<@input type='hidden' name='id_form' value='${form.id}' />
				<@formGroup labelKey='#i18n{forms.manageForm.labelStepTemplates}'>
					<@select name='id_template' items=template_provider.stepTemplateList />
				</@formGroup>
				<@formGroup>
					<@button type='submit' name='action_doImportTemplate' buttonIcon='check' title='#i18n{portal.admin.message.buttonValidate}' />
					<@button type='cancel' name='action_doCancelImport' buttonIcon='times' title='#i18n{portal.admin.message.buttonCancel}' cancel=true />
				</@formGroup>
			</@tform>
		</@modalBody>
	</@modal>
</#if>
<@scrollTopBtn />
