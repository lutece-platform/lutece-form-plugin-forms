
<#include "/admin/plugins/forms/edit_step_tabs.html" />

<#assign isOnlyOneStep=0>
<#if step.initial>
	<#assign isOnlyOneStep=isOnlyOneStep+1>
</#if>
<#if step.final>
	<#assign isOnlyOneStep=isOnlyOneStep+1>
</#if>

<@row>
    <@columns>
        <@formBreadCrumb>
            <li><@link href='jsp/admin/plugins/forms/ManageSteps.jsp?view=manageSteps&id_form=${form.id}' title='Liste des Ã©tapes'>${form.title}</@link></li>
            <li class="active">${step.title}</li>
        </@formBreadCrumb>
        <@box>
			<@boxHeader title='${step.title}' />
            <@boxBody>
                <@tabs color='clearfix'>
                    <@formStepTabs tab="transitions" />
                </@tabs>
                <@tabContent>
                    <@tabPanel id='manageStep' active=true>
                        <@row>
                            <@columns sm=4>
                                <@tform method='post' name='modify_step' action='jsp/admin/plugins/forms/ManageSteps.jsp'>
                                    <@messages errors=errors />
                                    <@input type='hidden' id='id_form' name='id_form' value='${step.idForm}' />
                                    <@input type='hidden' id='id_step' name='id_step' value='${step.id}' />
									
                                    <@formGroup labelKey='#i18n{forms.modify_step.labelTitle}' helpKey='#i18n{forms.modify_step.labelTitle.help}' mandatory=true rows=2>
                                        <@input type='text' name='title' value='${step.title!}' />
                                    </@formGroup>
                                    <@formGroup labelKey='#i18n{forms.modify_step.labelDescription}' helpKey='#i18n{forms.modify_step.labelDescription.help}' rows=2>
                                        <@input type='textarea' name='description'>${step.description!}</@input>
                                    </@formGroup>
                                    <@formGroup helpKey='#i18n{forms.modify_step.labelInitial.help}' rows=2>
                                        <@checkBox labelFor='initial' labelKey='#i18n{forms.modify_step.labelInitial}' name='initial' id='initial' value='1' checked=(step?has_content && step.initial) />
                                    </@formGroup>
                                    <@formGroup helpKey='#i18n{forms.modify_step.labelFinal.help}' rows=2>
                                        <@checkBox labelFor='final' labelKey='#i18n{forms.modify_step.labelFinal}' name='final' id='final' value='1' checked=(step?has_content && step.final) />
                                    </@formGroup>
                                    <@formsButton okAction='modifyStep' viewAction='' rows=2 />
                                </@tform>
                            </@columns>
                            <@columns sm=8>
                                <@table id='transitions'>
                                    <tr>
                                        <@th sm=6>#i18n{forms.manage_transitions.columnNextStep}</@th>
                                        <@th sm=1>#i18n{forms.manage_transitions.columnPriority}</@th>
                                        <@th sm=1 title='#i18n{forms.manage_questions.columnCondition}' hide=['xs']><@icon style='question'/></@th>
                                        <@th sm=4>#i18n{forms.manageForm.columnActions}
                                        <#if !step.final>               
                                            <@link href='jsp/admin/plugins/forms/ManageTransitions.jsp?view=createTransition&id_step=${step.id}' title='#i18n{forms.manage_transitions.buttonAdd}' params='data-toggle="modal" data-target="#transitionModal" data-url="jsp/admin/plugins/forms/ManageTransitions.jsp?view=createTransition&id_step=${step.id}" data-modal-title="#i18n{forms.create_transition.title}"'><@icon style='plus-square' /></@link>
                                        </#if>
                                        </@th>
                                    </tr>
                                    <#list transition_list as transition>
                                    <tr>
                                        <@td sm=6>${transition.nextStepTitle!''}</@td>
                                        <@td sm=1 valign='middle'><@badge>${transition.priority}</@badge></@td>
                                        <@td><#if transition.conditional><@icon style='question' /></#if></@td>
                                        <@td sm=4>
                                            <#if transition_index gt 0>
                                                <@aButton href='jsp/admin/plugins/forms/ManageTransitions.jsp?action=moveUpPriority&id_step=${step.id}&id_transition=${transition.id}' title='#i18n{forms.manage_transitions.action.moveUpPriorityTransition}' hideTitle=['all'] buttonIcon='chevron-up' size='sm' />
                                            </#if>
                                            <#if transition_has_next>
                                                <@aButton href='jsp/admin/plugins/forms/ManageTransitions.jsp?action=moveDownPriority&id_step=${step.id}&id_transition=${transition.id}' title='#i18n{forms.manage_transitions.action.moveDownPriorityTransition}' hideTitle=['all'] buttonIcon='chevron-down' size='sm' />
                                            </#if>
                                            <#--<@aButton href='jsp/admin/plugins/forms/ManageTransitions.jsp?view=modifyTransition&id_step=${step.id}&id_transition=${transition.id}' title='#i18n{forms.manage_transitions.action.modifyTransition}' hideTitle=['all'] buttonIcon='pencil' class='btn-iframe' size='sm' />-->
											
											<@button type='button' style='modal' class='btn-modal' buttonTargetId='#transitionModal' params='data-url="jsp/admin/plugins/forms/ManageTransitions.jsp?view=modifyTransition&id_step=${step.id}&id_transition=${transition.id}" data-modal-title="#i18n{forms.modify_transition.title}"' buttonIcon='pencil' size='sm' />
											
                                            <#-- <@aButton href='jsp/admin/plugins/forms/ManageControls.jsp?view=manageControl&id_step=${step.id}&id_target=${transition.id}&control_type=TRANSITION' title='#i18n{forms.manage_controls.action.modifyControl}' hideTitle=['all'] buttonIcon='cog' class='btn-modal' size='sm' /> --> 
											
											<@button type='button' buttonTargetId='#transitionModal' style='modal' params='data-url="jsp/admin/plugins/forms/ManageControls.jsp?view=manageControl&id_step=${step.id}&id_target=${transition.id}&control_type=TRANSITION"' title='#i18n{forms.manage_controls.action.modifyControl}' hideTitle=['all'] buttonIcon='cog' class='btn-modal' size='sm' />
											
                                            <@aButton href='jsp/admin/plugins/forms/ManageTransitions.jsp?view=confirmRemoveTransition&id_transition=${transition.id}' title='#i18n{forms.manage_transitions.action.removeTransition}' hideTitle=['all'] buttonIcon='trash' color='danger' size='sm' /> 
                                        </@td>
                                    </tr>
                                    </#list>
                                </@table>
                                <@alert id='tr-msg' color='warning'>
                                    #i18n{forms.manage_transitions.warning.final}
                                </@alert>
                            </@columns>
                        </@row>
                    </@tabPanel>
                </@tabContent>
            </@boxBody>
        </@box>
    </@columns>
</@row>

<@formModal id='transitionModal' />

<link rel="stylesheet" type="text/css" href="js/jquery/plugins/toastr/toastr.min.css" >
<script src="js/jquery/plugins/toastr/toastr.min.js"></script>

<script>
var steps=false, isOpen=false;    
$( function(){
    $('.btn-iframe').click( function(e){
        e.preventDefault();
        var iff = $('body').find('#iframe-forms');
        iff.remove();
        if( !isOpen ){
            $(this).parents('tr').after('<tr id="iframe-forms" class="open"><td colspan="4"><iframe id="modalIframe" src="' + $(this).attr('href') + '"><i class="fa fa-5x fa-sync fa-spin"></i></iframe></td></tr>' );
            isOpen=true;
        } else {
            isOpen=false;
        }
    });
	
	$('button.btn-modal').click( function(e){
		var iframeUrl = $(this).data("url");
		$("#transitionModal").find("#modalIframe").attr("src",iframeUrl);
    });

    if( $('#initial').prop('checked') && $('#final').prop('checked') ){
        steps=true; 
    } 
    
    $('#initial').change( function(){
        if( $('#initial').prop('checked') && $('#final').prop('checked') ){
            steps=true; 
        }  else {
            steps=false; 
        }
    })

    $('#final').change( function(){
        if( $('#initial').prop('checked') && $('#final').prop('checked') ){
            steps=true; 
        }  else {
            steps=false; 
        }
    })

    toastr.options.closeButton = true;
    toastr.options.timeOut = 0;
    toastr.options.extendedTimeOut = 0;

    <#if warnings??>
        <#if warnings?size &gt; 0 >
            <#list warnings as warning >
                toastr.warning("${warning.message}");
            </#list>	
        </#if>
    </#if>

    <#if error?has_content>
        <#list errors as error >
            toastr.error("${error.message}", "");
        </#list>	
    </#if>
    <#if infos?has_content>
        <#list infos as info >
            toastr.info("${info.message}", "");
        </#list>	
    </#if>
    
    $("#tr-msg").hide();

    <#if isOnlyOneStep=2>
        toastr.info('#i18n{forms.manage_transitions.info.multiple.step}');
        $("#transitions").hide();
        $("#tr-msg").show();
    </#if>
	
    $("#final").change( function(){
        if ( $(this).prop('checked') ){
            $("#transitions").hide();
            $("#tr-msg").show();
            if( steps ) {
			    toastr.warning("#i18n{forms.manage_transitions.warning.final}"); 
            } else {
			    toastr.warning("#i18n{forms.manage_transitions.info.step.initial.final}");
            }   
        } else {
            $("#transitions").show();
            $("#tr-msg").hide();
            toastr.clear();
        }
    });

});
</script>
