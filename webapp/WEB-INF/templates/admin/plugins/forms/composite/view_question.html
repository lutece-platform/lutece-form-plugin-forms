<div class="row <#if question??>display_field_${question.id}_${question.iterationNumber}</#if>" displayControl="${question.id}_${question.iterationNumber}">${questionContent}</div>
<#if list_validator??>
<input name='displayed_questions' id='${question.id}_${question.iterationNumber}' value='' hidden />
<script>
document.addEventListener('DOMContentLoaded', function() {
	<#assign validNames = [] />
	<#list list_validator as validator>
		<#if !validNames?seq_contains(validator.validatorBeanName)>
			<#assign validNames = validNames + [validator.validatorBeanName] />
			function validator_${validator.validatorBeanName?replace('.','_')}(inputValue,controlValue)
			{
				${validator.getJavascriptValidation()!'return true;'}
			}
		</#if>
	</#list>

	function getParentsUntil(element, stopSelector) {
		var parents = [];
		var parent = element.parentElement;
		while (parent && !parent.matches(stopSelector)) {
			parents.push(parent);
			parent = parent.parentElement;
		}
		return parents;
	}

	var hasCollapse=false, 
		toCollapse=null,
		displayFieldEl = document.querySelector('.display_field_${question.id!''}_${question.iterationNumber}'),
		stepGroup = displayFieldEl ? getParentsUntil(displayFieldEl, '.step-content') : [];
	stepGroup.forEach(function(el){
		if( el.classList.contains('step-group-collapsible') ){
			hasCollapse = el.querySelectorAll("div[class*='display_field_']:not(.control_invalid)").length == 0;
			toCollapse = el;
		}
	});
	var displayField = document.querySelector('.display_field_${question.id!''}_${question.iterationNumber}');
	var bOtherStepValidated = true;
	<#if other_step_validation??>
		<#if other_step_validation>
			if (displayField) displayField.style.display = '';
			document.getElementById('${question.id}_${question.iterationNumber}').value = '${question.id}_${question.iterationNumber}';
		<#else>
			if (displayField) {
				displayField.style.display = 'none';
				displayField.querySelectorAll("[required]").forEach(function(el) {
					el.setAttribute("requireddisabled", "");
					el.removeAttribute("required");
				});
			}
			document.getElementById('${question.id}_${question.iterationNumber}').value = '';
			bOtherStepValidated = false;
		</#if>
	</#if>
	
	<#list list_control as control>
		var displayControl = ${control.listIdQuestion[0]} + "_" + ${question.iterationNumber},
		input${control.id}_${question.iterationNumber} = getInputElement(displayControl);
		['change', 'keyup', 'paste', 'mouseup', 'input'].forEach(function(eventType) {
			input${control.id}_${question.iterationNumber}.forEach(function(inputEl) {
				inputEl.addEventListener(eventType, function(){
					var nValidControlsCount = 0;
					var nNotValidControlsCount = 0;
					<#list list_control as itemControl>
						var displayItemControl = ${itemControl.listIdQuestion[0]} + "_" + ${question.iterationNumber},
						input${itemControl.id}_${question.iterationNumber} = getInputElement(displayItemControl);
						stepGroup = displayFieldEl ? getParentsUntil(displayFieldEl, '.step-content') : [];
						stepGroup.forEach(function(el){
							if( el.classList.contains('step-group-collapsible') ){
								hasCollapse = el.querySelectorAll("div[class*='display_field_']:not(.control_invalid)").length == 0;
								toCollapse = el;
							}
						});
						inputValue = getFieldValue(input${itemControl.id}_${question.iterationNumber});
						// AND condition : if at least 1 control value isn't present, do not display question
						var controlDiv = document.querySelector("div[displayControl='${itemControl.listIdQuestion[0]}_${question.iterationNumber}']");
						if((controlDiv && controlDiv.classList.contains("control_invalid"))	|| !validator_${itemControl.validatorName?replace('.','_')}( inputValue, '${itemControl.value}')){
							nNotValidControlsCount++;
						} else {
							nValidControlsCount++;
						}
					</#list>
					var bIsQuestionDisplayed;
					<#if logical_operator_label == 'or'>
						bIsQuestionDisplayed = (nValidControlsCount > 0) || bOtherStepValidated;
					<#else>
						bIsQuestionDisplayed = (nNotValidControlsCount == 0) && bOtherStepValidated;
					</#if>
					if(bIsQuestionDisplayed)
					{
						if (displayField) {
							displayField.classList.remove("control_invalid");
							displayField.style.display = '';
							displayField.querySelectorAll("[requireddisabled]").forEach(function(el) {
								el.setAttribute("required", "");
								el.removeAttribute("requireddisabled");
							});
						}
						if( hasCollapse && toCollapse ){ toCollapse.style.display = ''; }; // Show parent group if is in a collapse step-group
						document.getElementById('${question.id}_${question.iterationNumber}').value = '${question.id}_${question.iterationNumber}';
					} else {
						if (displayField) {
							displayField.classList.add("control_invalid");
							displayField.style.display = 'none';
							displayField.querySelectorAll("[required]").forEach(function(el) {
								el.setAttribute("requireddisabled", "");
								el.removeAttribute("required");
							});
						}
						if( hasCollapse && toCollapse ){ toCollapse.style.display = 'none'; } // Hide parent group if is in a collapse step-group
						document.getElementById('${question.id}_${question.iterationNumber}').value = '';
					}
					var currentControl = "${question.id}_${question.iterationNumber}";
					var currentInput = getInputElement(currentControl);
					if ( currentInput[0] != undefined && currentInput[0].type != 'file' ){
						currentInput[0].dispatchEvent(new Event('change', { bubbles: true }));
					}
				});
			});
		});
		if (input${control.id}_${question.iterationNumber}[0]) {
			input${control.id}_${question.iterationNumber}[0].dispatchEvent(new Event('change', { bubbles: true }));
		}
		toggleRequiredAttributesByVisibility();
	</#list>
});

/**
 * Toggles the "required" attribute on input fields based on their visibility.
 * If an input field is hidden (determined by a CSS class or style), the "required" attribute is removed,
 * preventing validation errors from occurring on non-visible fields during form submission.
 * This function helps ensure that only visible fields are validated as required.
 */
function toggleRequiredAttributesByVisibility() {
	document.querySelectorAll("div[displayControl]").forEach(function (div) {
		var inputs = div.querySelectorAll("input, select, textarea");

		// Check if this element is visible or has the class "control_invalid"
		var isHidden = div.classList.contains("control_invalid") || 
					   div.offsetParent === null || 
					   getComputedStyle(div).display === "none";

		inputs.forEach(function (input) {
			if (isHidden) {
				// If hidden or marked invalid, remove required
				input.removeAttribute("required");
			} else {
				// If visible, add required based on initial configuration
				if (input.getAttribute("data-mandatory") === "true") {
					input.setAttribute("required", "required");
				}
			}
		});
	});
}
</script>
<#else>
<input name='displayed_questions' id='${question.id}_${question.iterationNumber}' value='${question.id}_${question.iterationNumber}' hidden />
</#if>
<script>
function getInputElement( displayControl ){
	var types = ['input','select','textarea'];
	var elm = null;
	var container = document.querySelector("div[displayControl='" + displayControl + "']");
	if (!container) return null;
	
	for(var i=0; i < types.length && (elm == undefined || elm == null || elm.length <= 0); i++){
		elm = container.querySelectorAll(types[i]);
		if (elm.length > 0) break;
	}
	
	if (elm && elm.length > 0 && elm[0].tagName.toLowerCase() === 'input') {
		elm = document.querySelectorAll('input[name="' + elm[0].getAttribute('name') + '"]');
	}
	
	return elm && elm.length > 0 ? elm : null;
}

function getFieldValue( elm ){
	if(!elm || elm.length === 0) return '';
	
	var firstEl = elm[0];
	
	if(firstEl.type === 'radio'){
		var checkedRadio = document.querySelector('input[name="' + firstEl.name + '"]:checked');
		return checkedRadio ? checkedRadio.value : '';
	} else if (firstEl.type === 'checkbox')	{
		var resultChecked = [];
		for(var i=0; i < elm.length; i++){
			if (elm[i].checked){
				resultChecked.push(elm[i].value);
			}
		}
		return resultChecked;
	} else if (firstEl.tagName.toLowerCase() === 'select') {
		return firstEl.options[firstEl.selectedIndex].value;
	}
	//add other specific implementations here
	else {
		return firstEl.value;
	}
}

document.addEventListener('DOMContentLoaded', function() {
	document.querySelectorAll("button[name='action_addIteration']").forEach(function(button) {
		button.addEventListener("click", function() {
			var target = "#last_" + this.getAttribute("value");
			var form = this.closest("form");
			var newUrl = form.getAttribute("action").replace(/#current_step$/,target);
			form.setAttribute("action",newUrl);
		});
	});
});
</script>
<script src="js/jquery/plugins/moment.min.js"></script>