<#--
-- Check if the checkbox must be checked or not
-- @param code the checkbox code
-- @param referecen_list the default values list
-- @return the String 'checked="checked" if the checkbox must be checked, an empty String otherwise
-->
<#function getChecked code reference_list>
	<#if reference_list?has_content>
		<#list reference_list as reference_item>
			<#if reference_item.code = code>
				<#if reference_item.checked>
  					<#return true>
  				<#else>
  					<#return false>
  				</#if>
  			</#if>
  		</#list>
	</#if>
	<#return false>
</#function>
<#--
-- Get the value of the parameter
-- @param code the code of the parameter
-- @param referecen_list the default values list
-- @return the value of the parameter
-->
<#function getName code reference_list default=''>
	<#if reference_list?has_content>
		<#list reference_list as reference_item>
			<#if reference_item.code = code>
  				<#return reference_item.name>
  			</#if>
  		</#list>
	</#if>
	<#return default>
</#function>
<#--
-- Get the field from a given title
-- @param entry the entry
-- @param fieldTitle the title
-- @return the field
-->
<#function getField entry fieldTitle>
	<#if entry.fields?? && entry.fields?has_content>
		<#list entry.fields as field>
			<#if field?? && field.title?? && field.title == fieldTitle>
				<#return field>
			</#if>
		</#list>
	</#if>
</#function>
<#--
-- Get the field from a given code
-- @param entry the entry
-- @param fieldCode the code
-- @return the field
-->
<#function getFieldByCode entry fieldCode>
    <#if entry.fields?? && entry.fields?has_content>
        <#list entry.fields as field>
            <#if field?? && field.code?? && field.code == fieldCode>
                <#return field>
            </#if>
        </#list>
    </#if>
</#function>
<#-- 
-- Get the field value from a given entry and a given title
-- @param entry the entry
-- @param fieldTitle the title
-- @return the field
-->
<#function getFieldValue entry fieldTitle>
	<#if getField( entry, fieldTitle )??>
		<#assign field = getField( entry, fieldTitle )>
		<#return field.value>
	</#if>
	<#return "">
</#function>
<#-- 
-- Get the field value from a given entry and a given title
-- @param entry the entry
-- @param fieldTitle the title
-- @return the field
-->
<#function getFieldValueByCode entry fieldCode>
	<#if getFieldByCode( entry, fieldCode )??>
		<#assign field = getFieldByCode( entry, fieldCode )>
		<#return field.value>
	</#if>
	<#return "">
</#function>
<#-- 
-- Get the response containing the field with the given title
-- @param responses the list of responses
-- @param the fieldCode the code
-- @return the response
-->
<#function getResponseContainingTheFieldWithTitle responses fieldTitle>
  <#if responses??>
    <#list responses as response>
      <#if response.field?? && response.field.title?? && response.field.title == fieldTitle >
        <#return response />
      </#if>
    </#list>
  </#if>
</#function>
<#-- 
-- Get the response containing the field with the given code
-- @param responses the list of responses
-- @param the fieldCode the code
-- @return the response
-->
<#function getResponseContainingTheFieldWithCode responses fieldCode>
  <#if responses??>
    <#list responses as response>
      <#if response.field?? && response.field.code?? && response.field.code == fieldCode >
        <#return response />
      </#if>
    </#list>
  </#if>
</#function>
<#-- 
-- Get the response from a given entry
-- WARNING : use only if the entry has ONE response
-- @param responses the list of responses
-- @param entry the entry
-- @return the response entry
-->
<#function getResponse responses entry>
  <#if responses??>
    <#list responses as response>
      <#if response.entry.idEntry == entry.idEntry>
        <#return response />
      </#if>
    </#list>
  </#if>
</#function>
<#-- 
-- Get the response entry from a given entry
-- @param responses the list of responses
-- @param entry the entry
-- @return the response entry
-->
<#function getResponseEntry responses entry>
  <#if responses??>
    <#list responses as response>
      <#if response.entry.idEntry == entry.idEntry>
        <#return response.entry />
      </#if>
    </#list>
  </#if>
</#function>
<#-- 
-- Get the error for the given entry
-- @param responses the list of responses
-- @param entry the entry
-- @return the error
-->
<#function getError responses entry>
  <#if getResponseEntry( responses, entry )??>
    <#assign responseEntry = getResponseEntry( responses, entry ) >
    <#return responseEntry.error />
  </#if>
</#function>
<#-- 
-- Get the max files value of an entry
-- @param entry the entry
-- @return the number of max authorized uploaded files
-->
<#function getMaxFiles entry>
	<#assign fieldMaxFiles = getFieldValueByCode( entry, "max_files" )>
	<#if fieldMaxFiles?? && fieldMaxFiles != "">
		<#return fieldMaxFiles>
	</#if>
	<#return "1">
</#function>
<#-- 
-- Get the max size an uploaded file is authorized to have
-- @param entry the entry
-- @return the max size
-->
<#function getFileMaxSize entry>
	<#assign fieldFileMaxSize = getFieldValueByCode( entry, "file_max_size" )>
	<#if fieldFileMaxSize?? && fieldFileMaxSize != "">
		<#return fieldFileMaxSize>
	<#else>
		<#if getField( entry, "option" )??>
			<#assign fieldFileMaxSize = getFieldByCode( entry, "option" )>
			<#return fieldFileMaxSize.width> 
		</#if>
	</#if>
	<#return "5242880">
</#function>
<#--
-- Check if the given entry must export the binary
-- @param entry the entry
-- @return true if it must export the binaries, false otherwise
-->
<#function exportBinary entry>
	<#assign field = getFieldValueByCode( entry, "export_binary" ) />
	<#if field?? && field = "true">
		<#return true />
	</#if>
	<#return false />
</#function>
<#--
-- Build the entry name
-- @param entry the entry
-- @param entry_iteration_number the iteration number
-- @return the name
-->
<#function buildEntryName entry entry_iteration_number='' >
  <#assign name = 'attribute' + entry.idEntry>
  <#if entry_iteration_number?? && entry_iteration_number?has_content>
    <#assign name = 'nIt' + entry_iteration_number + '_attribute' + entry.idEntry>
  </#if>
  <#return name />
</#function>
<#macro formEditor >
<#assign cssFiles="editor.css, page_template_styles.css" />
<#assign editorLocale="" />
<#-- We only have the language pack for French (France) installed in webapp/js/editors/tinymce/langs -->
<#-- Some lutece plugins pass locale.getLanguage() (="fr"), some pass the locale object (toString="fr_FR", or more complicated...) -->
<#-- Force it here because if it is a wrong value, tinyMCE does not load -->
<#if locale?? && (2 <= locale?string?length) && (locale?string?substring(0,2) == "fr")>
	<#assign editorLocale="fr_FR" />
</#if>
<script src="${webapp_url!}js/admin/editors/tinymce/tinymce.min.js"></script>
<script>
tinyMCE.init({
	// General options ${editorLocale}
	forced_root_block : '',
	selector : "textarea.richtext",
	theme : "modern",
	document_base_url : "${webapp_url!}",
	menubar : false,
	<#if editorLocale != "">language : '${editorLocale}',</#if>
	plugins: [ "link image lists charmap hr anchor pagebreak nonbreaking contextmenu paste textcolor" ],
	// Extended elements
	extended_valid_elements : "iframe[style|src|width|height|name|align|frameborder|scrolling],script[src|type],i[class]",
	paste_word_valid_elements: "b,strong,i,em,h1,h2,h3,p,br",
	content_css: "${cssFiles}",
	toolbar: "bold italic | forecolor | alignleft aligncenter alignright alignjustify | bullist | link | code",
	contextmenu: "link image | paste copy cut | forecolor backcolor ",
	});
</script>
</#macro>
<#macro toastr infos warnings errors msg='' msgType='info' clickUrl=''>
<link rel="stylesheet" type="text/css" href="js/admin/jquery/plugins/toastr/toastr.min.css" >
<script src="js/admin/jquery/plugins/toastr/toastr.min.js"></script>
<script>
$( function(){
<#if clickUrl !=''>
	toastr.options.onclick = function () {
		window.location.replace('${clickUrl}')
	};
</#if>
<#if warnings?has_content>
	<#list warnings as warning >
		toastr.warning("${warning.message}");
	</#list>	
</#if>
<#if errors?has_content>
	<#list errors as error >
		toastr.error("${error.message}");
	</#list>	
</#if>
<#if infos?has_content>
	<#list infos as info >
		toastr.info("${info.message}");
	</#list>	
</#if>
<#if msg !=''>
	<#if msgType='info'>
		toastr.info("${msg}");
	</#if>
	<#if msgType='warning'>
		toastr.warning("${msg}");
	</#if>
	<#if msgType='danger'>
		toastr.warning("${msg}");
	</#if>
</#if>
});
</script>
</#macro>
<#macro formBreadCrumb home='jsp/admin/plugins/forms/ManageForms.jsp'>
<@row>
	<@breadcrumbs id='breadforms' params=' style="margin-bottom:1em; background-color:transparent;"'>
		<@breadcrumbItem>
			<@link href=home title='Retour liste des formulaires'>
				<@icon style='home' />
			</@link>
		</@breadcrumbItem>
		<#nested>
	</@breadcrumbs>
</@row>
</#macro>     
<#macro formModal id='pubModal' title=''>
<@modal id='${id}'>
	<#if token??>
		<@input type='hidden' id='token' name='token' value='${token}' />
	</#if>
	<@modalHeader />
    <iframe id="modalIframe" src=""></iframe>
</@modal>
<script>
$('#${id}').on('show.bs.modal', function (event) {
	var button = $(event.relatedTarget);
	modalSrc = button.data('url');
	modalTitle = button.data('modal-title');
	modal = $(this);
 	modal.find('.modal-title').text(modalTitle);
 	modal.find('.modal-content #modalIframe').attr('src', modalSrc );
});
</script>
</#macro>
<#macro headerButton name='view_manageForm' label='portal.admin.message.buttonCancel' validate=true>
<#if validate>
	<#assign color = '' />
	<#assign buttonIcon = 'check' />
<#else>
	<#assign color = 'danger' />
	<#assign buttonIcon = 'times' />
</#if>
<@button type='submit' name='${name}' title='#i18n{${label}}' cancel=!validate buttonIcon=buttonIcon color=color />
</#macro>
<#macro formsButton okAction='' viewAction='' rows=1>
<@button type='submit' id='action_${okAction}' name='action_${okAction}' buttonIcon='check' title='#i18n{portal.admin.message.buttonValidate}' />
<#nested>
<#if viewAction !=''>
	<@button type='submit' name='view_${viewAction}' title='#i18n{portal.admin.message.buttonCancel}' cancel=true buttonIcon='times' />
</#if>
</#macro>
<#macro modalFrameScript formId actionId title modalId='qModal' iframeId='modalIframe' modalHeight=70 >
<script>
// Function to check if a webpage is in iFrame
function isIniFrame() {
 	return window.self !== window.top ? true : false;
}

$( function() {
    if ( isIniFrame() ){
		$('body').css( 'overflow-x', 'hidden' ).css('background-color', 'white');
        $('.skipnav').hide();
		$('nav').hide();
		$('.content-header').hide();
		$('#admin-wrapper').css( 'margin', '0' ).css( 'overflow-x', 'hidden' );
		$('.container-fluid').css( 'padding', '0' );
        $('.modal-body').css( 'padding', '24px' );
        $('main').css( 'margin', '0' );
		$('#breadforms').remove();
		$('header').remove();
		$('#footer').remove();
		<#if title !=''>
		var modalTitle = '${title}';
		window.parent.$('#${modalId}').find('.modal-title').text(modalTitle);
		$('#${modalId}').find('.modal-title').text(modalTitle);
		</#if>
		window.parent.$('#${iframeId}').css('height','${modalHeight!}vh');
		$('#${iframeId}').css('height','${modalHeight!}vh');
		
		<#if formId !=''>
		var formAction = $('#${formId}'), btnAction = $('#${actionId}');
		btnAction.click( function(e){ 
			formAction.submit( function(){
				e.preventDefault();
				formAction.attr( 'target', '_top' );
				_this.unbind('submit').submit();
			});
		});
		</#if>
    }  else {
        $('#${modalId} .content-header').hide();
        $('#${modalId} #admin-wrapper').css( 'margin', '0' );
        $('#${modalId} header').hide();
        $('#${modalId} footer').hide();
    }
});
</script>
</#macro>
<#macro formModel>
	<#include "/admin/plugins/asynchronousupload/upload_commons.html" />
	<@addRequiredJsFiles />
	<script type="text/javascript" src="jsp/admin/plugins/asynchronousupload/GetMainUploadJs.jsp?handler=${uploadHandler.handlerName}" ></script>
	<@row> 
		<@columns md=7> 
			<@fieldSet legend='#i18n{forms.modify_form.labelDescription}'>
				<@formGroup labelKey='#i18n{forms.modify_form.labelTitle}' helpKey='#i18n{forms.modify_form.labelTitle.help}' mandatory=true rows=2>
					<@input type='text' name='title' value='${form.title!}' />
				</@formGroup>
				<@formGroup labelKey='#i18n{forms.modify_form.labelDescription}' helpKey='#i18n{forms.modify_form.labelDescription.help}' rows=2>
						<@input type='textarea' name='description'>${form.description!}</@input>
				</@formGroup>
				<@formGroup labelKey='#i18n{forms.modify_form.labelCategory}' helpKey='#i18n{forms.modify_form.labelCategory.help}' rows=2>
						<@select name='id_category' items=categoryList default_value='${form.idCategory!}' />
				</@formGroup>
				<@formGroup labelKey='#i18n{forms.modify_form.labelLogo}' helpKey='#i18n{forms.modify_form.labelLogo.help}' rows=2>
					<@addFileInput fieldName="upload_logo" handler=uploadHandler submitBtnName='action_doSynchronousUploadDocument' cssClass='' multiple=true />
					<#if !listFiles??><#assign listFiles = ''></#if>
					<div id="listUpload">
						<@addUploadedFilesBox fieldName="upload_logo" handler=uploadHandler submitBtnName='action_doSynchronousUploadDocument' listFiles=listFiles />
					</div>
				</@formGroup>
			</@fieldSet>
			<@fieldSet legend='#i18n{forms.create_form.labelDates}'>  
				<@row>
					<@columns xs=12 sm=6>   
						<@formGroup labelKey='#i18n{forms.modify_form.labelStartDate}' rows=2>
							<@inputGroup>
							<#assign availabilityStartDatestr = ""><#if form.availabilityStartDate?? ><#assign availabilityStartDatestr = form.availabilityStartDate?string["yyyy-MM-dd HH:mm:ss"]></#if>
									<@input type='datetime' language=locale name='availabilityStartDate' id='availabilityStartDate'  value='${availabilityStartDatestr}' />
									<@inputGroupItem type='text'>
										<@icon style='calendar' />
									</@inputGroupItem>
							</@inputGroup>
						</@formGroup>
					</@columns>       
					<@columns xs=12 sm=6>  
						<@formGroup labelKey='#i18n{forms.modify_form.labelEndDate}' rows=2>     
							<@inputGroup>
							<#assign availabilityEndDatestr = ""><#if form.availabilityEndDate?? ><#assign availabilityEndDatestr = form.availabilityEndDate?string["yyyy-MM-dd HH:mm:ss"]></#if>
									<@input type='datetime' language=locale name='availabilityEndDate' id='availabilityEndDate' value='${availabilityEndDatestr}' />
									<@inputGroupItem type='text'>
										<@icon style='calendar' />
									</@inputGroupItem>
							</@inputGroup>
						</@formGroup>
					</@columns>    
				</@row>
				<@row>
					<@columns xs=12 sm=12>
						<@formGroup labelKey='#i18n{forms.modify_form.labelUnavailableMessage}' helpKey='#i18n{forms.modify_form.labelUnavailableMessage.help}' rows=2>
								<@input type='textarea' name='unavailableMessage'>${form.unavailableMessage!}</@input>
						</@formGroup>
					</@columns>
				</@row>
			</@fieldSet>
			<@fieldSet legend='#i18n{forms.create_form.display.labelRestrictions}'>
				<@row>     
					<@columns xs=12 sm=4>  
						<@formGroup labelFor='max_number_response' labelKey='#i18n{forms.create_form.labelMaxNumberResponse}' helpKey='#i18n{forms.create_form.labelMaxNumberResponseComment.help}' rows=2>
							<@input name='maxNumberResponse' id='maxNumberResponse' type='number' value=form.maxNumberResponse?string!'0' />
						</@formGroup>
					</@columns>     
					<@columns xs=12 sm=4>       
						<@formGroup labelKey='#i18n{forms.create_form.labelAuthentificationNeeded}' helpKey='#i18n{forms.create_form.labelAuthentificationNeeded.help}' hideLabel=['all'] rows=2>
							<@checkBox labelFor='authentificationNeeded' labelKey='#i18n{forms.create_form.labelAuthentificationNeeded}' name='authentificationNeeded' id='authentificationNeeded' value='1' checked=(form?has_content && form.authentificationNeeded) />
						</@formGroup>
					</@columns>       
					<@columns xs=12 sm=4>           
						<@formGroup labelKey='#i18n{forms.create_form.labelLimitNumberResponse}' helpKey='#i18n{forms.create_form.labelLimitNumberResponse.help}' hideLabel=['all'] rows=2>
							<@checkBox labelFor='oneResponseByUser' labelKey='#i18n{forms.create_form.labelLimitNumberResponse}' name='oneResponseByUser' id='oneResponseByUser' value='1' checked=(form?has_content && form.oneResponseByUser) />
						</@formGroup>
						<@formGroup labelKey='#i18n{forms.create_form.labelBackupEnabled}' helpKey='#i18n{forms.create_form.labelBackupEnabled.help}' hideLabel=['all'] rows=2>
							<@checkBox labelFor='backupEnabled' labelKey='#i18n{forms.create_form.labelBackupEnabled}' name='backupEnabled' id='backupEnabled' value='1' checked=(form?has_content && form.backupEnabled) />
						</@formGroup>
					</@columns> 
				</@row>          
			</@fieldSet>
			<@fieldSet legend='#i18n{forms.create_form.display.label}'>
				<@row>
					<@columns xs=12 sm=6> 
						<@formGroup labelKey='#i18n{forms.modify_form.labelBreadcrumb}' helpKey='#i18n{forms.modify_form.labelBreadcrumb.help}' mandatory=true rows=2>
							<@select name='breadcrumbName' items=breadcrumbTypes default_value='${form.breadcrumbName!}' />
						</@formGroup>
					</@columns>
				</@row>
				<@row>
					<@columns xs=12 sm=6>
						<@formGroup labelKey='#i18n{forms.create_form.labelCountResponses}' helpKey='#i18n{forms.create_form.labelCountResponses.help}' hideLabel=['all'] rows=2>
							<@checkBox labelFor='countResponses' labelKey='#i18n{forms.create_form.labelCountResponses}' name='countResponses' value='1' checked=(form?has_content && form.countResponses) />
						</@formGroup>
					</@columns>
				</@row>
			</@fieldSet>
		</@columns>
		<@columns md=5>
			<@fieldSet legend='#i18n{forms.create_form.labelDisplaySummary}'>
				<@formGroup labelKey='#i18n{forms.create_form.labelReturnUrl}' helpKey='#i18n{forms.create_form.labelReturnUrl.help}' rows=2>
					<@input type='text' name='returnUrl' value='${form.returnUrl!}' />
				</@formGroup>
				<@formGroup labelKey='#i18n{forms.create_form.labelLabelFinalButton}' rows=2>
					<@input type='text' name='labelFinalButton' value='${form.labelFinalButton!}' />
				</@formGroup>
				<@formGroup labelKey='#i18n{forms.create_form.labelDisplaySummary}' hideLabel=['all'] helpKey='#i18n{forms.create_form.labelDisplaySummary.help}' rows=2>
					<@checkBox labelKey='#i18n{forms.create_form.labelDisplaySummary}' labelFor='displaySummary' name='displaySummary' id='displaySummary' value='1' checked=(form?has_content && form.displaySummary) />
				</@formGroup>
				<@formGroup labelKey='#i18n{forms.create_form.labelEndMessageDisplay}' hideLabel=['all'] id='labelEndMessage' helpKey='#i18n{forms.create_form.labelEndMessageDisplay.help}'  rows=2>
					<@checkBox labelKey='#i18n{forms.create_form.labelEndMessageDisplay}' labelFor='endMessageDisplay' name='endMessageDisplay' id='endMessageDisplay' value='1' checked=(formMessage?has_content && formMessage.endMessageDisplay) />
				</@formGroup>
				<@formGroup labelKey='#i18n{forms.create_form.labelEndMessage}' id='endMessage' helpKey='#i18n{forms.create_form.labelEndMessage.help}' rows=2>
					<@input type='textarea' name='endMessage' richtext=true>${formMessage.endMessage!}</@input>
				</@formGroup>
			</@fieldSet> 
			<#if workflow_list?has_content && workflow_list?size gt 1>
				<@fieldSet legend='#i18n{forms.modify_form.workflow.label}'>
					<@formGroup labelKey='#i18n{forms.modify_form.workflow.label}' rows=2>
						<@select name='idWorkflow' items=workflow_list default_value='${form.idWorkflow!}' />
					</@formGroup>
				</@fieldSet> 
			</#if>
			<#if accesscontrol_list?has_content && accesscontrol_list?size gt 1>
				<@fieldSet legend='#i18n{forms.modify_form.accesscontrol.label}'>
					<@formGroup labelKey='#i18n{forms.modify_form.accesscontrol.label}' rows=2>
						<@select name='id_accesscontrol' items=accesscontrol_list default_value='${accesscontrol_id!}' />
					</@formGroup>
				</@fieldSet> 
			</#if>
			<#if is_active_captcha>
				<@fieldSet legend='#i18n{forms.modify_form.captcha.label}'>
					<@formGroup labelKey='#i18n{forms.modify_form.labelCaptchaStepInitial}' hideLabel=['all'] id='labelCaptchaStepInitial' helpKey='#i18n{forms.modify_form.labelCaptchaStepInitial.help}'  rows=2>
						<@checkBox labelKey='#i18n{forms.modify_form.labelCaptchaStepInitial}' labelFor='captchaStepInitial' name='captchaStepInitial' value='1' checked=(form?has_content && form.captchaStepInitial) />
					</@formGroup>
					<@formGroup labelKey='#i18n{forms.modify_form.labelCaptchaStepFinal}' hideLabel=['all'] id='labelCaptchaStepFinal' helpKey='#i18n{forms.modify_form.labelCaptchaStepFinal.help}'  rows=2>
						<@checkBox labelKey='#i18n{forms.modify_form.labelCaptchaStepFinal}' labelFor='captchaStepFinal' name='captchaStepFinal' value='1' checked=(form?has_content && form.captchaStepFinal) />
					</@formGroup>
					<@formGroup labelKey='#i18n{forms.modify_form.labelCaptchaRecap}' hideLabel=['all'] id='labelCaptchaRecap' helpKey='#i18n{forms.modify_form.labelCaptchaRecap.help}'  rows=2>
						<@checkBox labelKey='#i18n{forms.modify_form.labelCaptchaRecap}' labelFor='captchaRecap' name='captchaRecap' value='1' checked=(form?has_content && form.captchaRecap) />
					</@formGroup>
				</@fieldSet> 
			</#if>
		</@columns>
	</@row>
</#macro>
<#macro formVisualize>
<div class="modal fade" id="modalPDF" tabindex="-1" role="dialog">
	<div class="modal-dialog modal-lg" role="document" style="width:80vw;">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
					<h4 class="modal-title">Etapes ${form.title}</h4>
			</div>
			<div class="modal-body" style="height:80vh;">
				<iframe src="" style="position:absolute;left:0; top:0; height:80vh; bottom:0; width:100%; padding:0;"></iframe>
			</div>
			<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Fermer</button>
			</div>
		</div>
	</div>
</div>
<link rel="stylesheet" type="text/css" href="js/admin/plugins/forms/vis/vis-network.min.css" >
<script src="js/admin/plugins/forms/vis/vis.min.js"></script>
<script src="js/admin/plugins/forms/vis/jspdf.min.js"></script>
<script>
	$( function(){
		$("#renderNetwork").toggle();
		$(".state-actions").toggle();
		$(".state").nextAll().hide();
	});

	var base64Img = null;
	imgToBase64('images/admin/skin/plugins/forms/logo_site.png', function(base64) {
    	base64Img = base64; 
	});

	$("#toggleMap").click( function( e ){
		e.preventDefault();
		$("#list").fadeToggle();
		$("#renderNetwork").fadeToggle();
		$(this).children('i').toggleClass('fa-project-diagram').toggleClass('fa-list-alt');
	});

    // create an array with nodes
	<#assign nStepCount = step_list?size>
	<#assign nIndex = 1>
	var nodes = new vis.DataSet([
    <#list step_list as step>
		{id: ${step.id}, label: "${step.title} <#if step.initial> - Etape initiale</#if><#if step.final> - Etape finale</#if> ",x:undefined,y:undefined}<#if nIndex &lt; nStepCount>,</#if>
		<#assign nIndex = nIndex+1>
	</#list>
	]);

	 // create an array with edges
 	var edges = new vis.DataSet([
	 	<#assign nTransitionCount = transition_list?size >
		<#assign nIndex = 1>
		<#assign rndDess = -0.2>
		<#list transition_list?sort_by('fromStep') as transition>
		 	{id: ${(transition.id)!''}, from: ${(transition.fromStep)!''}, to: ${(transition.nextStep)!''}, smooth: {type: 'curvedCW', roundness:0.2} , arrows:'to', label:"${(transition.controlTitle)!''}", title: "Priorité : ${(transition.priority)!''} : ${(transition.fromStepTitle)!''} / ${(transition.nextStepTitle)!''} / ${(transition.controlTitle)!''}", font:{align: 'top'}}<#if nIndex &lt; nTransitionCount>,</#if>
		</#list>
	]);

	var locales = {
		en: {
			edit: 'Edit',
			del: 'Delete selected',
			back: 'Back',
			addNode: 'Add Node',
			addEdge: 'Add Edge',
			editNode: 'Edit Node',
			editEdge: 'Edit Edge',
			addDescription: 'Click in an empty space to place a new node.',
			edgeDescription: 'Click on a node and drag the edge to another node to connect them.',
			editEdgeDescription: 'Click on the control points and drag them to a node to connect to it.',
			createEdgeError: 'Cannot link edges to a cluster.',
			deleteClusterError: 'Clusters cannot be deleted.',
			editClusterError: 'Clusters cannot be edited.'
		},
		fr: {
			edit: 'Editer',
			del: 'Supprimer la s\u00E9lection',
			back: 'Retour',
			addNode: 'Ajoute un \u00E9tat',
			addEdge: 'Ajouter une action',
			editNode: 'Editer l\'\u00E9tat',
			editEdge: 'Editer l\'action',
			addDescription: 'Cliquer dans un espace vide pour cr\u00E9er un \u00E9tat.',
			edgeDescription: 'Cliquer sur un \u00E9tat et atteindre un autre \u00E9tat pour associer une actions.',
			editEdgeDescription: 'Cliquer sur un \u00E9tat s\u00E9lectionn\u00E9 et atteindre un autre \u00E9tat pour associer une actions.',
			createEdgeError: 'On ne peut lier une action et un cluster.',
			deleteClusterError: 'Clusters ne peuvent \u00EAtre d\u00E9truit.',
			editClusterError: 'Clusters ne peuvent \u00EAtre \u00E9dit\u00E9.'
		}
	}

    // create a network
    var container = document.getElementById('mynetwork');

    // provide the data in the vis format
    var data = {
        nodes: nodes,
        edges: edges
    };
    var options = {
		autoResize: true,
		locale: 'fr',
  		locales: locales,
  		height: '100%',
  		width: '100%',
  		interaction:{ 
		  hover:true,
		  navigationButtons: true,
		},
		physics: {
      		enabled: false
    	},
		layout: {
			randomSeed: 1,
			improvedLayout:true,
			hierarchical: {
				enabled:false,
			}
		},
		// TODO : gérer les actions
		manipulation: {
			enabled: false,
			initiallyActive: false,
			// addNode: function(nodeData,callback) {
			// 	el = 'jsp/admin/plugins/workflow/CreateState.jsp?id_workflow=' ;
			// 	window.location.replace( el );
			// },
			addEdge: function(edgeData,callback) {
				el = 'jsp/admin/plugins/forms/ManageTransitions.jsp?view=createTransition&id_step=' + edgeData.from + '&id_step_after=' + edgeData.to;
				window.location.replace( el );
			},
			editEdge: function(edgeData,callback) {
				el = 'jsp/admin/plugins/forms/ManageTransitions.jsp?view=modifyTransition&' + edgeData.from + '&id_transition=' + edgeData.id;
				window.location.replace( el );
			},
			// deleteNode: function(nodeData,callback) {
			// 	el = '' +  nodeData.nodes[0];
			// 	window.location.replace( el );
			// },
			deleteEdge: function(edgeData,callback) {
				el = 'jsp/admin/plugins/forms/ManageTransitions.jsp?view=confirmRemoveTransition&id_transition=' +  edgeData.id;
				window.location.replace( el );
			}
		},
		nodes: {
			shape: 'box',
			margin: 10,
			size: 25,
            font: {
                size: 12,
                color: '#000'
            },
            borderWidth: 2
        },
        edges: {
            width: 3,
			scaling: {
				min: 10,
				max: 30
			},
        },
	};

    // Initialisation du network!
    var network = new vis.Network(container, data, options);

    network.on("doubleClick", function (params) {
        params.event = "[original event]";
        var elNode = params.nodes[0],  elEdge = params.edges[0], el='';
		if( elNode !== undefined ){
			el = 'jsp/admin/plugins/forms/ManageQuestions.jsp?view=manageQuestions&id_step=' + elNode;
		} else if( elEdge !== undefined ) {
			el = 'jsp/admin/plugins/workflow/ModifyAction.jsp?id_action=' +  elEdge;
		}
		window.location.replace( el );
    });
	
	/* Function pour recréer le network
	 - h : Paramètre qui défini si le network est de présentation hierachique | valeurs : true ou false
	 - d : Paramètre qui défini l'orien,tation de la présentation hierachique | valeurs : UD,DU,LR,RL
	*/
	function draw( h, d ) {
        options.layout.hierarchical.enabled=h;
        options.layout.hierarchical.direction=d;
        network = new vis.Network(container, data, options);
    }
	
	/* Bouton choix de l'orientation pour une représentation hiérachique */
	$( "#direction > select" ).change(function() {
		var di = $(this).val();
		draw( true, di );
	});

	// Sauve les positions
	$("#save_network").click( function(){
		saveNetwork();
	});

	// Récupère les positions depuis localStorage
	$("#get_network").click( function(){
		var savedNodesPosition = getStoredPositions();
		setNodesPosition( savedNodesPosition );
		draw( false, 'UD' );
	});
	
	// Sauve les positions dans localStorage
	function saveNetwork() {
		var n = objectToArray( network.getPositions() );
		var exportValue = JSON.stringify( n, undefined, 2);
		localStorage.setItem( 'id_step_' , exportValue );
	}

	/* Récupère le dernière version en localStorage */
	function getStoredPositions(){
		var step_data = localStorage.getItem( 'id_step_' );
		var inputData = JSON.parse( step_data );
		return inputData;
	}	
	
	/* Enregistre les dernières positions en localStorage */
	function setNodesPosition( p ){
		var networkNodes=[];
		p.forEach( function( elem, index, array ) {
			nodes.update({id: elem.id, x: elem.x, y: elem.y});
		});
	}
	
	/* Génération PDF 								*/
	/* Var pour récupérer objet canvas du network 	*/
	var imgData='',canvasW=0,canvasH=0;
	network.on("afterDrawing", function (ctx) {
		 imgData = ctx.canvas.toDataURL('image/png');
		 canvasW= ctx.canvas.width/3;
		 canvasH= ctx.canvas.height/3;
	});
	
	/* Var définition des marges pour le PDF */
	margins = {	top: 70, bottom: 60, left: 30, width: 550 };

	/* Fonction de génération du PDF */
	generateDoc = function( view ){
		var docWkf = new jsPDF({
			orientation: 'landscape',
			unit: 'px',
			format: 'a4'
		});
		
		docWkf.addImage( imgData, 'PNG', 15, 60, canvasW, canvasH);
		docWkf.addPage('a4','l');
		// We'll make our own renderer to skip this editor
		var specialElementHandlers = {
			'.btn': function(element, renderer){
				return true;
			},
			'th': function(element, renderer){
				return true;
			},
			'.form-inline': function(element, renderer){
				return true;
			}
		};
		docWkf.setTextColor(100);
		docWkf.setFontSize(22);
		docWkf.text(105, 65, 'Liste des Etapes');
		docWkf.setDrawColor( 23, 93, 146 );
		docWkf.setLineWidth(1);
		docWkf.line(15, 70, 600, 65);
		docWkf.setTextColor(0,0,0);
	
		docWkf.setFontSize(18);
		docWkf.fromHTML($('#list').get(0),  
		margins.left, // x coord
		margins.top,
		{
			'elementHandlers': specialElementHandlers,
			width: margins.width
		}, function(dispose) {
			headerFooterFormating( docWkf, docWkf.internal.getNumberOfPages());
		}, 
		margins);
		if( view ){
			$('#modalPDF iframe').attr('src', docWkf.output('datauristring') );
			$('#modalPDF').modal('show');
		} else {
			docWkf.save("steps.pdf");
		}
			
	};
	
	// Insère le header et le footer
	function headerFooterFormating(doc, totalPages)	{
		for(var i = totalPages; i >= 1; i--) {
			doc.setPage(i);                            
			header(doc);
			footer(doc, i, totalPages);
			doc.page++;	
		}
	};

	// Prépare le header
	function header(doc) {
		if ( base64Img ) {
			doc.addImage( base64Img, 'png', 10, 15 );        
		}
		doc.setTextColor(100);
		doc.setFontSize(22)
		doc.text(130, 35, 'Forms : les Etapes')
		doc.setTextColor(150);
		doc.setFontSize(12)
		// doc.text(105, 45, 'Etapes')
		doc.setDrawColor( 23, 93, 146 );
		doc.setLineWidth(1);
		doc.line( 3, 70, margins.width + 400 ); // horizontal line
	};
	
	// Prépare le footer
	function footer(doc, pageNumber, totalPages) {
		var str = "Page " + pageNumber + " sur " + totalPages
		doc.setFontSize(10);
		doc.text(str, margins.left + 10, doc.internal.pageSize.height - 40);
	};

	// Bouton generation preview PDF
	$("#previewPDF").click( function () {
		generateDoc( true );
	});

	// Bouton generation téléchargement PDF
	$("#downloadPDF").click( function () {
	 	generateDoc( false );
	});

	/* Utils */
	function objectToArray(obj) {
		return Object.keys(obj).map(function (key) {
			obj[key].id = key;
			return obj[key];
		});
	}

	function imgToBase64( url, callback, imgVariable) {
		if (!window.FileReader) {
			callback(null);
			return;
		}
		var xhr = new XMLHttpRequest();
		xhr.responseType = 'blob';
		xhr.onload = function() {
			var reader = new FileReader();
			reader.onloadend = function() {
				imgVariable = reader.result.replace('text/xml', 'image/jpeg');
				callback(imgVariable);
			};
			reader.readAsDataURL(xhr.response);
		};
		xhr.open('GET', url);
		xhr.send();
	};
 </script>
</#macro>
<#macro dateFilterJs>
<link rel="stylesheet" type="text/css" href="css/admin/plugins/forms/daterangepicker.css">
<script type="text/javascript" src="js/jquery/plugins/moment.min.js"></script>
<script type="text/javascript" src="js/jquery/plugins/daterangepicker.js"></script>
<script>
$(function() {
	$("[name='formsFilterDate']").each( function( index )
	{
		var filter='#' + $( this ).val(), filter_to=filter+'_to', filter_from=filter+'_from';
		$(filter).daterangepicker( {
		ranges: {
			"#i18n{forms.multiviewForms.dateRangePicker.today}": [moment(), moment()],
			"#i18n{forms.multiviewForms.dateRangePicker.yesterday}": [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
			"#i18n{forms.multiviewForms.dateRangePicker.week}": [moment().subtract(6, 'days'), moment()],
			"#i18n{forms.multiviewForms.dateRangePicker.month}": [moment().subtract(29, 'days'), moment()],
			"#i18n{forms.multiviewForms.dateRangePicker.months}": [moment().subtract(90, 'days'), moment()],
		},
		opens: 'right',
		alwaysShowCalendars: true,
		autoUpdateInput: false,
		locale: {
		format: '#i18n{forms.multiviewForms.dateRangePicker.format}',
		applyLabel: "#i18n{forms.multiviewForms.dateRangePicker.applyLabel}",
		cancelLabel: "#i18n{forms.multiviewForms.dateRangePicker.cancelLabel}",
		fromLabel: "#i18n{forms.multiviewForms.dateRangePicker.fromLabel}",
		toLabel: "#i18n{forms.multiviewForms.dateRangePicker.toLabel}",
		customRangeLabel: "#i18n{forms.multiviewForms.dateRangePicker.customRangeLabel}",
		weekLabel: "#i18n{forms.multiviewForms.dateRangePicker.weekLabel}",
		daysOfWeek: [
			"#i18n{forms.multiviewForms.dateRangePicker.daysOfWeekSun}",
			"#i18n{forms.multiviewForms.dateRangePicker.daysOfWeekMon}",
			"#i18n{forms.multiviewForms.dateRangePicker.daysOfWeekTue}",
			"#i18n{forms.multiviewForms.dateRangePicker.daysOfWeekWen}",
			"#i18n{forms.multiviewForms.dateRangePicker.daysOfWeekThu}",
			"#i18n{forms.multiviewForms.dateRangePicker.daysOfWeekFri}",
			"#i18n{forms.multiviewForms.dateRangePicker.daysOfWeekSat}"
		],
		monthNames: [
			"#i18n{forms.multiviewForms.dateRangePicker.monthNames1}",
			"#i18n{forms.multiviewForms.dateRangePicker.monthNames2}",
			"#i18n{forms.multiviewForms.dateRangePicker.monthNames3}",
			"#i18n{forms.multiviewForms.dateRangePicker.monthNames4}",
			"#i18n{forms.multiviewForms.dateRangePicker.monthNames5}",
			"#i18n{forms.multiviewForms.dateRangePicker.monthNames6}",
			"#i18n{forms.multiviewForms.dateRangePicker.monthNames7}",
			"#i18n{forms.multiviewForms.dateRangePicker.monthNames8}",
			"#i18n{forms.multiviewForms.dateRangePicker.monthNames9}",
			"#i18n{forms.multiviewForms.dateRangePicker.monthNames10}",
			"#i18n{forms.multiviewForms.dateRangePicker.monthNames11}",
			"#i18n{forms.multiviewForms.dateRangePicker.monthNames12}"
		],
		}
		}, 
		function(start, end, label) {
			$(filter_from).val( start.format('#i18n{forms.multiviewForms.dateRangePicker.format}') );
			$(filter_to).val( end.format('#i18n{forms.multiviewForms.dateRangePicker.format}') );
			$(filter).val ( start.format('#i18n{forms.multiviewForms.dateRangePicker.format}') + " - " + end.format('#i18n{forms.multiviewForms.dateRangePicker.format}') );
			$('#searchForm').submit();
		});
  		
		$(filter).on('cancel.daterangepicker', function(ev, picker) {
		//do something, like clearing an input
		var startD = moment().day(-30);
		var endD = moment().day(30);
		$(this).data('daterangepicker').setStartDate(startD);
		$(this).data('daterangepicker').setEndDate(endD);
		$(this).val('');
	  	$(filter_from).val ('');
  		$(filter_to).val ('');

		});
	});
});
</script>
</#macro>
<#macro scrollTopBtn>
<a href="#" id="scroll" style="display: none;"><span></span></a>
<script>
$( function(){ 
    $(window).scroll(function(){ 
        if ( $(this).scrollTop() > 100) { 
            $('#scroll').fadeIn(); 
        } else { 
            $('#scroll').fadeOut(); 
        } 
    }); 
    $('#scroll').click(function(){ 
        $("html, body").animate({ scrollTop: 0 }, 600); 
        return false; 
    }); 
});
</script>
</#macro>
<#macro headerSort field title jsp_url attribute id='' >
<#if jsp_url?contains("?")>
	<#assign sort_url = jsp_url + "&amp;sorted_attribute_name=" + attribute + "&amp;asc_sort=" />
<#else>
	<#assign sort_url = jsp_url + "?sorted_attribute_name=" + attribute + "&amp;asc_sort=" />
</#if>
<th data-field="${field}" class="th-header" id="sort${id!}_${attribute!}">
	${title}
	<div class="btn-sort-group" role="group" aria-label="Tri">
		<@aButton hideTitle=['all'] color='' style="" class="btn-sort asc" href="${sort_url}true#sort${id!}_${attribute!}" title="#i18n{portal.util.sort.asc}" >
			<@icon style='sort-up fa-fw' />
		</@aButton>	
		<@aButton hideTitle=['all'] color='' style="" class="btn-sort desc" href="${sort_url}false#sort${id!}_${attribute!}" title="#i18n{portal.util.sort.desc}">	
			<@icon style='sort-down fa-fw' />
		</@aButton>	
	</div>
</th>
</#macro>
<#macro jsHeaderSort>
<script>
$( function(){ 
    var sortId=window.location.hash, sortCol=$(sortId);
		if( sortId !='' ){
			var sUrl=window.location.search.split('&'), bAsc=sUrl[3].split('='), isAsc=bAsc[1];
			sortCol.toggleClass('th-active');
			if( isAsc=='false' ){
				$( sortId + ' .btn-sort.desc' ).toggleClass('active');
			} else {
				$( sortId + ' .btn-sort.asc' ).toggleClass('active');
			}
		}
});
</script>
</#macro>