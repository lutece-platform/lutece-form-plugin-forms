<#assign editModeValue = ''>
<#assign viewNumberValue = '1'>
<#assign addressValue = '' />
<#assign idAddressValue = '' />
<#assign xValue = '' />
<#assign yValue = '' />
<#assign geometryValue = '' />
<#assign hasError = false />
<#assign entryClass=''>
<#assign entryClass>position-relative <#list entry.CSSClass?split(' ') as laClass>${laClass!}</#list></#assign>
<#assign idName = buildEntryName( entry, entry_iteration_number )>
<#if list_responses??><#list list_responses as response><#if response.entry.idEntry == entry.idEntry && response.entry.error?? && response.entry.error.isDisplayableError><#assign hasError = true /><#assign error = response.entry.error></#if></#list></#if>
<#assign errorMsg><#if hasError><#if error.mandatoryError>#i18n{forms.message.mandatory.entry}<#else>${error.errorMessage}</#if></#if></#assign>
<#assign helpMsg><#if entry.helpMessage?? && entry.helpMessage!=''>${entry.helpMessage}</#if></#assign>
<#assign iterationNumber = entry_iteration_number?c >
<#assign hasCheckAddress = entry.CSSClass?? && entry.CSSClass?contains("checkaddress") />
<#if entry.fields??>
<#assign addressField = getFieldValueByCode( entry, "address" )>
<#assign viewNumberValue = getFieldValueByCode( entry, "viewNumber" )>
<#assign editModeValue = getFieldValueByCode( entry, "editMode" )>
</#if>
<#assign useAddressAutocomplete = entry.mapProvider?? && entry.mapProvider?has_content && (entry.mapProvider.key! == 'wsaddress' || entry.mapProvider.key! == 'openstreetmap') />
<#if useAddressAutocomplete>
    <#include "/admin/plugins/address/modules/autocomplete/include/suggestPOI.html" />
</#if>
<#if entry.mapProvider??>
    <@formGroup labelFor='${idName}_address' labelKey='${entry.title}' helpKey=helpKey!'' class=entryClass! mandatory=entry.mandatory htmlRequired=false rows=2>
    <#if list_responses?? && list_responses?has_content>
        <#assign addressValue = getResponseContainingTheFieldWithCode(list_responses, "address").toStringValueResponse />
        <#assign idAddressValue = getResponseContainingTheFieldWithCode(list_responses, "idAddress").toStringValueResponse />
        <#assign xValue = getResponseContainingTheFieldWithCode(list_responses, "X").toStringValueResponse />
        <#assign yValue = getResponseContainingTheFieldWithCode(list_responses, "Y").toStringValueResponse />
        <#assign geometryValue = getResponseContainingTheFieldWithCode(list_responses, "geometry").toStringValueResponse />
        <#if getError( list_responses, entry )?? ><#assign error = getError( list_responses, entry ) ></#if>
    </#if>
    <#if editModeValue == '' || editModeValue?starts_with('Address') || editModeValue?starts_with('Adresse')>
        <#if useAddressAutocomplete>
            <@suggestPOIInput id="${idName}_address" name="${idName}_address" currentValue="${addressValue!}" required=entry.mandatory cssClass="form-geoloc<#if hasError> is-invalid</#if>" />
        <#else>
            <input type="text" class="form-control form-geoloc<#if hasError> is-invalid</#if>" name="${idName}_address" id="${idName}_address" value="${addressValue!}"<#if entry.mandatory> required</#if> />
        </#if>
    <#else>
        <input type="hidden" name="${idName}_address" id="${idName}" value="${addressValue!}" <#if !entry.mandatory > required</#if> >
    </#if>
    <input type="hidden" name="${idName}_idAddress" id="${idName}_idAddress" value="${idAddressValue!}">
    <input type="hidden" name="${idName}_x" id="${idName}_x" value="${xValue!}">
    <input type="hidden" name="${idName}_y" id="${idName}_y" value="${yValue!}">
    <input type="hidden" name="${idName}_geometry" id="${idName}_geometry" value="${geometryValue!}">
    <#if hasError>
        <@div class="invalid-feedback"><#if error.mandatoryError>#i18n{forms.message.mandatory.entry}<#else>${error.errorMessage}</#if></@div>
    </#if>
    <#if entry.helpMessage?exists&&entry.helpMessage!=''><small class="form-text text-muted">${entry.helpMessage}</small></#if>
    <#if entry.mapProvider?has_content>
        <@p params='hidden'>${entry.mapProvider.key!}</@p>
        <#if viewNumberValue?has_content && entry.mapProvider.getParameter(viewNumberValue?number)?? && entry.mapProvider.getParameter(viewNumberValue?number).mapParameter??>
            <#assign map_parameter = entry.mapProvider.getParameter(viewNumberValue?number).mapParameter >
        </#if>
        <#if viewNumberValue?has_content && entry.mapProvider.getParameter(viewNumberValue?number)?? && entry.mapProvider.getParameter(viewNumberValue?number).addressParam?? >
            <#assign add_parameter = entry.mapProvider.getParameter(viewNumberValue?number).addressParam >
        </#if>
        <#include entry.mapProvider.htmlCode />
    </#if>
    </@formGroup>
    <#if entry.mapProvider?has_content && useAddressAutocomplete>
        <@setupSuggestPOI />
        <script>
        document.addEventListener('DOMContentLoaded', function() {
            var iterationNumber = '${entry_iteration_number}';
            var numberIterInput = document.getElementById('number_iteration_geolocation');
            if (!numberIterInput) {
                numberIterInput = document.createElement('input');
                numberIterInput.type = 'hidden';
                numberIterInput.id = 'number_iteration_geolocation';
                numberIterInput.name = 'number_iteration_geolocation';
                var formValidate = document.getElementById('form-validate');
                if (formValidate) {
                    formValidate.appendChild(numberIterInput);
                }
            }
            if (numberIterInput) {
                numberIterInput.value = iterationNumber;
            }

            var hasCheckAddress = ${hasCheckAddress?c};
            var autocompleteContainer = document.getElementById('${idName}_address');
            var searchInput = autocompleteContainer.querySelector('.lutece-autocomplete-search-input');
            var inputIdAddress = document.getElementById('${idName}_idAddress');
            var inputX = document.getElementById('${idName}_x');
            var inputY = document.getElementById('${idName}_y');
            var inputGeometry = document.getElementById('${idName}_geometry');

            var suggestPoi = new SuggestPOI(autocompleteContainer, {
                allowFreeText: !hasCheckAddress
            });

            autocompleteContainer.addEventListener(SuggestPOI.EVT_SELECT, function(event) {
                var poi = event.detail.poi;
                if (poi) {
                    inputGeometry.value = poi.type || '';
                    inputY.value = poi.y || '';
                    inputX.value = poi.x || '';
                    inputIdAddress.value = poi.id || '';
                    autocompleteContainer.classList.add('wssuggest');
                    searchInput.classList.remove('is-invalid');
                    var feedback = autocompleteContainer.querySelector('.invalid-feedback');
                    if (feedback) {
                        feedback.remove();
                    }
                    enableSubmitButtons();
                    sessionStorage.setItem('wsvalidated_${entry.idEntry}', 'done');
                }
            });

            function enableSubmitButtons() {
                document.querySelectorAll('[name="action_doSaveStep"], [name="action_doSaveResponse"], [name="action_formResponseSummary"]').forEach(function(btn) {
                    btn.removeAttribute('disabled');
                });
            }

            function disableSubmitButtons() {
                document.querySelectorAll('[name="action_doSaveStep"], [name="action_doSaveResponse"], [name="action_formResponseSummary"]').forEach(function(btn) {
                    btn.setAttribute('disabled', 'disabled');
                });
            }

            function showInvalidFeedback() {
                searchInput.classList.add('is-invalid');
                if (!autocompleteContainer.querySelector('.invalid-feedback')) {
                    var feedback = document.createElement('div');
                    feedback.className = 'invalid-feedback d-block';
                    feedback.textContent = '#i18n{forms.message.geolocation.checkAdress}';
                    autocompleteContainer.appendChild(feedback);
                }
            }

            var wsv = sessionStorage.getItem('wsvalidated_${entry.idEntry}');
            if (wsv === 'done') {
                autocompleteContainer.classList.add('wssuggest');
                enableSubmitButtons();
            }

            if (hasCheckAddress) {
                searchInput.addEventListener('input', function() {
                    if (autocompleteContainer.classList.contains('wssuggest')) {
                        autocompleteContainer.classList.remove('wssuggest');
                        disableSubmitButtons();
                    }
                });

                var form = autocompleteContainer.closest('form');
                if (form) {
                    form.addEventListener('submit', function(e) {
                        if (!autocompleteContainer.classList.contains('wssuggest')) {
                            e.preventDefault();
                            showInvalidFeedback();
                            disableSubmitButtons();
                        }
                    });
                }
            }
        });
        </script>
    </#if>
</#if>
<link rel="stylesheet" href="themes/admin/shared/plugins/forms/css/geoloc.css">
