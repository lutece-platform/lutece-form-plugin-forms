<#assign idName = buildEntryName( entry, entry_iteration_number )>
<#assign sortableListType=getFieldValueByCode( entry, "sortable_list_type" )>
<#assign isMultiListSelection = (sortableListType?? && sortableListType=='1')>
<#if entry.helpMessage?exists&&entry.helpMessage!=''>
  <#assign helpKey=entry.helpMessage />
</#if>
<#if list_responses??>
	<#list list_responses as response>
	  <#if response.entry.idEntry == entry.idEntry && response.entry.error??>
		<#assign groupStyle = 'error' />
		<#break>
	  </#if>
	</#list>
	<#assign inputClass = entry.CSSClass! />
</#if>
<@formGroup labelFor='${idName}' labelKey='${entry.title}' helpKey=helpKey!'' groupStyle=groupStyle!'' mandatory=entry.mandatory htmlRequired=false  rows=2>
	<#if isMultiListSelection>
		<@row class='mt-3'>
		    <@input type='hidden' name='${idName}' id='${idName}' />
		    <#assign hasErrors=false>
				<@columns sm=6>
					<@box>
						<@boxHeader title='#i18n{forms.create_entry.sortableList.availableItems}' />
						<@boxBody class='p-3'>
							<@listGroup id='sortable1' class="connectedSortable ${inputClass}" params='style="min-height:10rem;"'>
								<#list entry.fields as field>
									<#if field.code == 'answer_choice'>
										<#assign isSelected=false />
										<#if list_responses?has_content>
											<#list list_responses as response>
												<#if response.entry.idEntry == entry.idEntry && response.field??>
													<#if response.field.idField == field.idField>
														<#assign isSelected=true />
													</#if>
												</#if>
											</#list>
										</#if>
										<#if !isSelected>
											<@listGroupItem id='field_${field.idField}'
												class='ui-state-default d-flex justify-content-between'>
												${field.title}
											</@listGroupItem>
										</#if>
									</#if>
								</#list>
							</@listGroup>
						</@boxBody>
					</@box>
				</@columns>
				<@columns sm=6>
					<#assign hasErrors=false />
					<@box>
						<@boxHeader title='#i18n{forms.create_entry.sortableList.selectedItems}' />
						<@boxBody class='p-3'>
							<@listGroup id='sortable2' class="connectedSortable ${inputClass}" params='style="min-height:10rem;"'>
								<#if list_responses?has_content>
									<#list list_responses?sort_by('sortOrder') as response>
										<#if response.entry.idEntry == entry.idEntry && response.entry.error??>
											<#assign hasErrors=true />
											<#break>
										<#else>
											<#list entry.fields as field>
												<#if response.field.idField == field.idField>
													<@listGroupItem id='field_${field.idField}'
														class='ui-state-default justify-content-between d-flex justify-content-between'>
														${field.title}
													</@listGroupItem>
												</#if>
											</#list>
										</#if>
									</#list>
								</#if>
							</@listGroup>
						</@boxBody>
					</@box>
				</@columns>
				<#if hasErrors>
					<@alert color='danger'>#i18n{forms.message.mandatory.entry}</@alert>
			    </#if>
		    <script>
				document.addEventListener('DOMContentLoaded', function () {
					const sortable1 = document.getElementById('sortable1');
					const sortable2 = document.getElementById('sortable2');
					const form = document.querySelector('form');
					const idNameInput = document.getElementById('${idName}');

					function makesortable(element) {
						let draggedItem = null;

						element.addEventListener('dragstart', function (e) {
							if (e.target.tagName === 'LI') {
								draggedItem = e.target;
								e.target.style.opacity = '0.5';
							}
						});

						element.addEventListener('dragend', function (e) {
							e.target.style.opacity = '1';
						});

						element.addEventListener('dragover', function (e) {
							e.preventDefault();
							e.dataTransfer.dropEffect = 'move';
						});

						element.addEventListener('drop', function (e) {
							e.preventDefault();
							if (draggedItem && draggedItem.parentElement !== element) {
								element.appendChild(draggedItem);
							}
						});
					}

					document.querySelectorAll('.connectedSortable li').forEach(item => {
						item.draggable = true;
					});

					makeortable(sortable1);
					makeortable(sortable2);

					form.addEventListener('submit', function () {
						if (sortable2.children.length === 0) {
							idNameInput.value = Array.from(sortable1.children)
								.map(li => li.id.replace('field_', 'field='))
								.join(';');
						} else {
							idNameInput.value = Array.from(sortable2.children)
								.map(li => li.id.replace('field_', 'field='))
								.join(';');
						}
					});
				});
			</script>
		</@row>
	<#else>
		<@row class='mt-3'>
		    <@input type='hidden' name='${idName}' id='${idName}' />
		    <#assign hasErrors=false>
			<@columns sm=12>
				<@listGroup id='sortable1' class="connectedSortable ${inputClass}">
					<#list entry.fields as field>
						<#if field.code == 'answer_choice'>
							<#assign isSelected=false />
							<#if list_responses?has_content>
								<#list list_responses as response>
									<#if response.entry.idEntry == entry.idEntry && response.field??>
										<#if response.field.idField == field.idField>
											<#assign isSelected=true />
										</#if>
									</#if>
								</#list>
							</#if>
							<#if !isSelected>
								<@listGroupItem id='field_${field.idField}'
									class='ui-state-default d-flex justify-content-between'>
									${field.title}
								</@listGroupItem>
							</#if>
						</#if>
					</#list>
				</@listGroup>
				<@listGroup id='sortable2' class="connectedSortable ${inputClass}">
					<#if list_responses?has_content>
						<#list list_responses?sort_by('sortOrder') as response>
							<#if response.entry.idEntry==entry.idEntry && response.entry.error??>
								<#assign hasErrors=true />
								<#break>
							<#else>
								<#list entry.fields as field>
									<#if response.field.idField == field.idField>
										<@listGroupItem id='field_${field.idField}'
											class='ui-state-default justify-content-between d-flex justify-content-between'>
											${field.title}
										</@listGroupItem>
									</#if>
								</#list>
							</#if>
						</#list>
					</#if>
				</@listGroup>
			</@columns>
			<#if hasErrors>
				<@alert color='danger'>#i18n{forms.message.mandatory.entry}</@alert>
		    </#if>
		    <script>
				document.addEventListener('DOMContentLoaded', function () {
					const sortable1 = document.getElementById('sortable1');
					const sortable2 = document.getElementById('sortable2');
					const form = document.querySelector('form');
					const idNameInput = document.getElementById('${idName}');
					let draggedItem = null;

					function makeListSortable(element) {
						element.addEventListener('dragstart', function (e) {
							if (e.target.tagName === 'LI') {
								draggedItem = e.target;
								e.target.style.opacity = '0.5';
							}
						});

						element.addEventListener('dragend', function (e) {
							e.target.style.opacity = '1';
						});

						element.addEventListener('dragover', function (e) {
							e.preventDefault();
							e.dataTransfer.dropEffect = 'move';
						});

						element.addEventListener('drop', function (e) {
							e.preventDefault();
							if (draggedItem) {
								element.appendChild(draggedItem);
							}
						});
					}

					document.querySelectorAll('.connectedSortable li').forEach(item => {
						item.draggable = true;
					});

					makeListSortable(sortable1);
					makeListSortable(sortable2);

					form.addEventListener('submit', function () {
						const sourceList = sortable2.children.length > 0 ? sortable2 : sortable1;
						idNameInput.value = Array.from(sourceList.children)
							.map(li => li.id.replace('field_', 'field='))
							.join(';');
					});
				});
			</script>
		</@row>
	</#if>
</@formGroup>
